---
title: "T2D"
output:
  pdf_document: default
  html_document: default
date: "2024-10-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r libraries, include=FALSE}
# Libraries
library(data.table)
library(survival)
#install.packages("rtmle")
#devtools::install_github("tagteam/rtmle")
library(rtmle)
library(ggplot2)
library(prodlim)
theme_set(theme_bw())
```

# Inverstigation of T2D trial 

The overall aim of the project is to investigate how to analyse if a drug which has an established beneficial effect on an intermediate event (onset of diabetes is delayed for people taking the drug) has an additional benefit on a terminal event (death). 

Intuitively it seems that we have answered this question by answering the specific questions

- What is the effect of the drug on the probability of death?
- What is the effect of the drug on the probability of death among T2D subjects?

However, assume that it is also well-known that the intermediate event is a risk factor for the terminal event. Then the effect of the drug on the terminal event could be 100% mediated through the intermediate event. The (naively asked) question is if using and having used the drug helps people when they get diabetes. The major challenge is the selection of the people in the study over time: people are randomized at the start of the study but at the onset of diabetes they are not randomized anymore:

+ people who are already dead are not there anymore but if the drug has an effect on death then the people who take the drug live longer and hence are more likely to get diabetes.
+ people are older in the treatment arm at the onset of diabetes due to the beneficial effect of the drug on preventing diabetes.

In the following we simulate healthcare data from a setting with 3 different types of events: Death, Censoring and T2D. Death and Censoring are terminal events and each individual can be diagnosed with T2D once. There are two baseline covariate $L_0$ and $L_1$, and a baseline treatment $A_0$ that affects the intensities of the different events. The covariate $L_0$ is uniform on $(40,60)$ and represents age. The binary covariate $L_1$ represents sex. The intensities of the different events follow the form

$$\lambda_{x}(t) =  R^x(t) \lambda_{0}(x,t)\phi(x,t)$$
The function $R^x(t)$ is an at risk indicator. The baseline hazard is specified as
$$\lambda_{0}(x,t)=\eta_x \nu_x t^{\nu_x-1} $$
And
$$\phi(x,t) = \exp \left(\frac{\beta_{L_0, x}}{50} L_0  + \beta_{L_1, x} L_1 + \beta_{A_0, x} A_0 + \beta_{L, x} L\right)$$

## Probability of getting T2D 

Let $T$ be the random variable representing time T2D diagnose. We in the following estimate
$$ P(T \leq 5 | A_0 = 1) \quad , \quad P(T \leq 5 | A_0 = 1)$$
By 
$$ \hat{P}(T \leq 5 | A_0 = 1) = \frac{\sum_{i=1}^N 1(T_i \leq 5, A_0 =1)}{N} \quad , \quad \hat{P}(T \leq 5 | A_0 = 0) = \frac{\sum_{i=1}^N 1(T_i \leq 5,  A_0 =0)}{N}$$
Where $T_i$ is the time of the T2D diagnose of individual $i$. 

We simulate from the T2D setting described above. We let the effect of T2D on Death, $\beta_{L \to D}$, vary from $0$ to $1$ by $0.1$. For each value of $\beta_{L \to D}$ we generate three data sets, where the effect of the initial treatment on the development of T2D is $0$, $-0.5$ and $-1$ respectively. For each data set we estimate the probabilities  $P(T \leq 5| A_0 = 1)$ and $P(T \leq 5| A_0 = 1)$

```{r}
N <- 7000

estimator1 <- function(data, N) {
  # Finding all the T2D people and setting T_0 to debut time of diabetes
    T2D_events <- data[Delta == 3]
    
    # Save estimate of absolute risk of developing T2D for people on Treatment and people not on Treatment
    return(c(nrow(T2D_events[A0 == 0 & Time < 5])/N, nrow(T2D_events[A0 == 1 & Time < 5])/N))
}
```

```{r, results='hide'}
res1 <- compare_effects(estimator = estimator1, N = N, beta_L_D = seq(0,1,by = 0.1))
```

```{r}
plot_compare(res1) +
      ylab("Probability of T2D after 5 years")+
      xlab("Effect of T2D on Death")
```
We see that the probability of getting T2D is reduced by the drug (as we have simulated), and the reduction does not depend on the effect T2D has on Death. 

We now vary the effect of the Drug on Death $\beta_{A_0 \to D}$, and see how this affects the T2D probability.  

```{r, results='hide'}
res2 <- compare_effects(estimator = estimator1, N = N, beta_A0_D = seq(-1,0,by = 0.1))
```


```{r, results='hide'}
plot_compare(res2, plot_no = 1, diff_betas <- seq(-1,0,by = 0.1)) +
      ylab("Probability of T2D after 5 years")+
      xlab("Effect of Drug on Death")
```
For the people without initial treatment, the probability of T2D is constant throughout the graph.
For the people on treatment the probability of getting T2D after 5 years is largest when the drug has an large effect on Death. Because less people die, there is a larger population ready to develop T2D. As the effect of the drug on T2D increases, the probability of getting T2D gets smaller for the people in the Treatment arm. 

## Survival probability 3 years after debut of T2D

Let $U$ be the random variable representing time of death after being diagnosed with T2D. We in the following estimate
$$ P(U > 3 | A_0 = 1, L_0 = 0.5, L_1 = 0) \quad , \quad P(U > 3 | A_0 = 0, L_0 = 0.5, L_1 = 0)$$

We estimate the survival probabilities by simulating data as previously. For each data set we estimate the survival function with the Kaplan Meyer estimator. For each fit we predict the survival probability 3 years after debut of T2D for an observation with $L_0 = 0.5$, $L_1 = 0$ and respectively $A_0 = 0$ and $A_0 = 1$. That is for a person on initial treatment, and a person not on initial treatment. 

```{r, results='hide'}
estimator2 <- function(data, N) {
    # Finding all the T2D people 
    T2D_events <- data[Delta == 3]
    T2D_peeps <- data[ID %in% T2D_events$ID]
    
    # Setting T_0 to debut time of diabetes
    T2D_peeps[, Time_T2D := Time - min(Time), by = ID]
    
    # Removing the new Time 0
    T2D_peeps <- T2D_peeps[Delta != 3]
    
    # Creating a status variable
    T2D_peeps[, Status := Delta == 1]
    
    # Kaplan meyer fit
    fit <- prodlim(Hist(Time_T2D, Status) ~ L0 + L1 + A0, data = T2D_peeps)
    
    # Save estimate of survival probability
    preds <- predict(fit, times = 3, newdata = data.frame(L0 = c(50,50), A0 = c(0,1), L1 = c(0,0)))
    return(c(preds$`L0=0.5, L1=0, A0=0`, preds$`L0=0.5, L1=0, A0=1`))
}

res3 <- compare_effects(estimator = estimator2, N = N, beta_L_D = seq(0,1,by = 0.1))
res4 <- compare_effects(estimator = estimator2, N = N, beta_A0_D = seq(-1,0,by = 0.1))
```

Visual illustration 
```{r}
plot_compare(res3, diff_betas= seq(0,1,by = 0.1))+
      ylab("Estimated survival probability")+
      xlab("Effect of T2D on Death")+
      labs(title = "3 year survival probability since T2D (no effect of drug on death)")
```
We see that as the effect of T2D on Death increases, the probability of survival decreases. It does so equally for both treatment and placebo group and for all effects of the drug on T2D. This is surprising since one would think that the age difference between the two groups would play a role. We will investigate this further in the following. 

```{r}
plot_compare(res4, diff_betas= seq(-1,0,by = 0.1))+
      ylab("Estimated survival probability")+
      xlab("Effect of Drug on Death")+
      labs(title = "3 year survival probability since T2D")
```

When the drug has an effect on Death, the survival probability after T2D diagnose is larger in the Treatment Group. Quite interestingly this survival probability does not depend on the size of the effect of the drug on T2D. This is weird since one would imagine that the larger the effect of the drug, the older the T2D treatment group, the larger the intensity of Death and the smaller survival probability. This is the same effect we were pondering about above, and we will look into this below. As the effect of the drug on Death decreases, the survival probability approaches the one in the placebo group. 

## Covariate differences

We look into the differences between the Treatment group and the placebo group in different scenarios.

### When there is no effect og drug on death

We simulate data where the effect of the drug on the development of T2D is respectively 0, -0.5, -1. And the effect of the drug on Death is 0. 

```{r}
data0 <- sim_data_setting2(N = 5 * 10^4, beta_L_D = 1, beta_A0_D = 0,
                           beta_L0_L = 1, beta_A0_L = 0)
data0.5 <- sim_data_setting2(N = 5 * 10^4, beta_L_D = 1, beta_A0_D = 0,
                           beta_L0_L = 1, beta_A0_L = -0.5)
data1 <- sim_data_setting2(N = 5 * 10^4, beta_L_D = 1, beta_A0_D = 0,
                           beta_L0_L = 0, beta_A0_L = -1, beta_L0_D = 1,
                           cens = 0)
```

We find the average initial age, the average time of T2D diagnose and number of patients among respectively placebo and treatment T2D diagnosed patients.

```{r}
# T2D events
T2D_events0 <- data0[Delta == 3]; T2D_events0.5 <- data0.5[Delta == 3]; T2D_events1 <- data1[Delta == 3]

# Mean baseline covariate of T2D diagnose
cbind(rbind(T2D_events0[, .(L0_mean = mean(L0)), by = A0],
      T2D_events0.5[, .(L0_mean = mean(L0)), by = A0],
      T2D_events1[, .(L0_mean = mean(L0)), by = A0]), "Effect of Drug on T2D" = c(0,0,-0.5,-0.5,-1,-1))
```

Both groups have a little bit larger than average baseline covariate.

```{r}
# Mean time of T2D diagnose
cbind(rbind(T2D_events0[, .(Time_mean = mean(Time)), by = A0],
      T2D_events0.5[, .(Time_mean = mean(Time)), by = A0],
      T2D_events1[, .(Time_mean = mean(Time)), by = A0]) , "Effect of Drug on T2D" = c(0,0,-0.5,-0.5,-1,-1))
```

The larger the effect of the drug the later the patients in the Treatment group develop T2D.

```{r}
# Number of individuals with T2D diagnose
cbind(rbind(T2D_events0[,  .N, by = A0],
      T2D_events0.5[,  .N, by = A0],
      T2D_events1[,  .N, by = A0]), "Effect of Drug on T2D" = c(0,0,-0.5,-0.5,-1,-1))
```

The number of patients developing T2D is equal for both groups when there is no effect of the drug. But fewer and fewer patients in the Treatment arm develop T2D as the effect of the drug increases due to censoring and death. 

We now naively look into the proportion of placebo and treatment T2D diagnosed patients that die by some time $\tau$  

```{r}
T2D_peeps0 <- data0[ID %in% T2D_events0$ID]; T2D_peeps0.5 <- data0.5[ID %in% T2D_events0.5$ID]; 
T2D_peeps1 <- data1[ID %in% T2D_events1$ID]

# Setting T_0 to debut time of diabetes
T2D_peeps0[, Time_T2D := Time - min(Time), by = ID]; T2D_peeps0.5[, Time_T2D := Time - min(Time), by = ID]
T2D_peeps1[, Time_T2D := Time - min(Time), by = ID]
# Removing the new Time 0
T2D_peeps0 <- T2D_peeps0[Delta != 3]; T2D_peeps0.5 <- T2D_peeps0.5[Delta != 3]
T2D_peeps1 <- T2D_peeps1[Delta != 3]
```

Proportion of treatment and placebo patients who have died before 1 year after T2D diagnose, when drug has no effect
```{r}
c(nrow(T2D_peeps0[Time_T2D < 1 & Delta == 1 & A0 == 1]) / length(unique(T2D_peeps0[A0 == 1]$ID)),
nrow(T2D_peeps0[Time_T2D < 1 & Delta == 1 & A0 == 0]) / length(unique(T2D_peeps0[A0 == 0]$ID)))
```

Proportion of treatment and placebo patients who have died before 1 year after T2D diagnose, when drug has small effect
```{r}
c(nrow(T2D_peeps0.5[Time_T2D < 1 & Delta == 1 & A0 == 1]) / length(unique(T2D_peeps0.5[A0 == 1]$ID)),
nrow(T2D_peeps0.5[Time_T2D < 1 & Delta == 1 & A0 == 0]) / length(unique(T2D_peeps0.5[A0 == 0]$ID)))
```

Proportion of treatment and placebo patients who have died before 1 year after T2D diagnose, when drug has large effect
```{r}
c(nrow(T2D_peeps1[Time_T2D < 1 & Delta == 1 & A0 == 1]) / length(unique(T2D_peeps1[A0 == 1]$ID)),
nrow(T2D_peeps1[Time_T2D < 1 & Delta == 1 & A0 == 0]) / length(unique(T2D_peeps1[A0 == 0]$ID)))
```

The proportions are not the same. For the treatment group the proportion of dead is smaller. 

```{r}
ggplot(T2D_peeps1[Delta != 3])+
  geom_histogram(aes(x = L0))+
  facet_grid(~A0)

summary(lm(L0 ~ A0, data = T2D_peeps1[Delta != 3]))
```



### When there is an effect og drug on death

We now simulate data where the effect of the drug on Death is -0.5. 

```{r}
data0 <- sim_data_setting2(N = 5 * 10^4, beta_L_D = 1, beta_A0_D = -0.5,
                           beta_L0_L = 1, beta_A0_L = 0)
data0.5 <- sim_data_setting2(N = 5 * 10^4, beta_L_D = 1, beta_A0_D = -0.5,
                           beta_L0_L = 1, beta_A0_L = -0.5)
data1 <- sim_data_setting2(N = 5 * 10^4, beta_L_D = 1, beta_A0_D = -0.5,
                           beta_L0_L = 1, beta_A0_L = -1)
```

We find the average initial age, the average time of T2D diagnose and number of patients among respectively placebo and treatment T2D diagnosed patients.

```{r}
# T2D events
T2D_events0 <- data0[Delta == 3]; T2D_events0.5 <- data0.5[Delta == 3]; T2D_events1 <- data1[Delta == 3]

# Mean baseline covariate of T2D diagnose
cbind(rbind(T2D_events0[, .(L0_mean = mean(L0)), by = A0],
      T2D_events0.5[, .(L0_mean = mean(L0)), by = A0],
      T2D_events1[, .(L0_mean = mean(L0)), by = A0]), "Effect of Drug on T2D" = c(0,0,-0.5,-0.5,-1,-1))
```

Both groups have a little bit larger than average baseline covariate.

```{r}
# Mean time of T2D diagnose
cbind(rbind(T2D_events0[, .(Time_mean = mean(Time)), by = A0],
      T2D_events0.5[, .(Time_mean = mean(Time)), by = A0],
      T2D_events1[, .(Time_mean = mean(Time)), by = A0]) , "Effect of Drug on T2D" = c(0,0,-0.5,-0.5,-1,-1))
```

The larger the effect of the drug the later the patients in the Treatment group develop T2D.

```{r}
# Number of individuals with T2D diagnose
cbind(rbind(T2D_events0[,  .N, by = A0],
      T2D_events0.5[,  .N, by = A0],
      T2D_events1[,  .N, by = A0]), "Effect of Drug on T2D" = c(0,0,-0.5,-0.5,-1,-1))
```

The number of patients developing T2D is equal for both groups when there is no effect of the drug. But fewer and fewer patients in the Treatment arm develop T2D as the effect of the drug increases due to censoring and death. 

We now naively look into the proportion of placebo and treatment T2D diagnosed patients that die by some time $\tau$  

```{r}
T2D_peeps0 <- data0[ID %in% T2D_events0$ID]; T2D_peeps0.5 <- data0.5[ID %in% T2D_events0.5$ID]; 
T2D_peeps1 <- data1[ID %in% T2D_events1$ID]

# Setting T_0 to debut time of diabetes
T2D_peeps0[, Time_T2D := Time - min(Time), by = ID]; T2D_peeps0.5[, Time_T2D := Time - min(Time), by = ID]
T2D_peeps1[, Time_T2D := Time - min(Time), by = ID]
# Removing the new Time 0
T2D_peeps0 <- T2D_peeps0[Delta != 3]; T2D_peeps0.5 <- T2D_peeps0.5[Delta != 3]
T2D_peeps1 <- T2D_peeps1[Delta != 3]
```

Proportion of treatment and placebo patients who have died before 1 year after T2D diagnose, when drug has no effect
```{r}
c(nrow(T2D_peeps0[Time_T2D < 1 & Delta == 1 & A0 == 1]) / length(unique(T2D_peeps0[A0 == 1]$ID)),
nrow(T2D_peeps0[Time_T2D < 1 & Delta == 1 & A0 == 0]) / length(unique(T2D_peeps0[A0 == 0]$ID)))
```

Proportion of treatment and placebo patients who have died before 1 year after T2D diagnose, when drug has small effect
```{r}
c(nrow(T2D_peeps0.5[Time_T2D < 1 & Delta == 1 & A0 == 1]) / length(unique(T2D_peeps0.5[A0 == 1]$ID)),
nrow(T2D_peeps0.5[Time_T2D < 1 & Delta == 1 & A0 == 0]) / length(unique(T2D_peeps0.5[A0 == 0]$ID)))
```

Proportion of treatment and placebo patients who have died before 1 year after T2D diagnose, when drug has large effect
```{r}
c(nrow(T2D_peeps1[Time_T2D < 1 & Delta == 1 & A0 == 1]) / length(unique(T2D_peeps1[A0 == 1]$ID)),
nrow(T2D_peeps1[Time_T2D < 1 & Delta == 1 & A0 == 0]) / length(unique(T2D_peeps1[A0 == 0]$ID)))
```

The proportions are not the same for the placebo and treatment group. For the treatment group the proportion of dead is smaller. But the proportions are constant no matter the effect of the drug. 


## Larger effect of time on intensity of death

```{r, results='hide'}
res5 <- compare_effects(estimator = estimator2, N = N, beta_L_D = seq(0,1,by = 0.1), nu = rep(1.3,4))
res6 <- compare_effects(estimator = estimator2, N = N, beta_A0_D = seq(-1,0,by = 0.1), nu = rep(1.3,4))
```


```{r}
plot_compare(res5, diff_betas= seq(0,1,by = 0.1))+
      ylab("Estimated survival probability")+
      xlab("Effect of T2D on Death")+
      labs(title = "3 year survival probability since T2D")

plot_compare(res6, diff_betas= seq(-1,0,by = 0.1))+
      ylab("Estimated survival probability")+
      xlab("Effect of Drug on Death")+
      labs(title = "3 year survival probability since T2D")
```

Increasing the effect of time on the intensities does not change the results...

## Helene forslag

*Generate large data*

```{r}
N <- 10^4
data_A <- sim_data_setting2(N = N, beta_L_D = 1, cens = 0, beta_A0_L = 1)
data_A[, at_risk_cov := as.numeric(L == 0)]
data_A_t <- trans_int_data(data_A)

survfit <- coxph(Surv(tstart, tstop, Delta == 3) ~ I(L0 / 50) + L1 + A0,
                      data = data_A_t[at_risk_cov == 1],
                      timefix = FALSE,
                      cluster = ID)

survfit$coefficients
```

*Grouping data based on treatment*

```{r}
no_treat_group <- data_A[A0 == 0]
treat_group <- data_A[A0 == 1]
```

*Fit Weibull*

I feel like there is something going wrong here
```{r}
survfit <- survreg(Surv(Time, Delta == 3) ~ I(L0 / 50) + L1, 
                   data = no_treat_group[at_risk_cov == 1], 
                   cluster = ID,
                   dist='weibull')

survfit1 <- survreg(Surv(Time, Delta == 3) ~ I(L0 / 50) + L1 + A0, 
                   data = data_A[at_risk_cov == 1], 
                   cluster = ID,
                   dist='weibull')
```


Estimates in no treatment group
```{r}
nu_est <- 1/survfit$scale; nu_est
eta_est <- 1/exp(survfit$coefficients[1]); eta_est
beta_l0_l_est <- - survfit$coefficients[2] / survfit$scale; beta_l0_l_est
beta_l1_l_est <- - survfit$coefficients[3] / survfit$scale; beta_l1_l_est

1/survfit1$scale
1/exp(survfit1$coefficients[1])
- survfit1$coefficients[2] / survfit1$scale
- survfit1$coefficients[4] / survfit1$scale
```

*Generate large data set under the intervened intensity *
```{r}
N <- 10^4
data_new <- sim_data_setting2(N = N, 
                              cens = 0,
                              eta = c(rep(0.1,3), eta_est),
                              nu = c(rep(1.1,3), nu_est),
                              beta_L0_L = beta_l0_l_est)
```

*Generate large data set without intervened intensity *
```{r}
data_new_no_int <- sim_data_setting2(N = N, cens = 0)
```

*Proportion of subjects dying before some time $\tau$*
```{r}
tau <- 3
mean(data_new[Delta == 1, Time] < tau) # with intervention
mean(data_new_no_int[Delta == 1, Time] < tau) # without intervention
```
A bit more dead under intervened intensity. 
