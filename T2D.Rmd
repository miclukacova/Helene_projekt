---
title: 'T2D'
output: html_document
date: "2024-10-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Libraries
library(data.table)
library(survival)
#install.packages("rtmle")
#devtools::install_github("tagteam/rtmle")
library(rtmle)
library(ggplot2)
library(microbenchmark)
theme_set(theme_bw())
source("~/Helene_projekt/funcs_for_two_settings.R")
```


```{r}
#plot_event_data(set2a_data)
#summary_sim_event(set2a_data)
# Fitting models
# Transform data into tstart tstop format
#mod_data_a <- trans_int_data(set2a_fu_data)
#mod_data_a[, at_risk_cov := as.numeric(L == 0)]
## Fit models
#survfit_death <- coxph(Surv(tstart, tstop, Delta == 1) ~ L0  + A0 + L, 
#                       data = mod_data_a, cluster = ID)
#survfit_cens <- coxph(Surv(tstart, tstop, Delta == 2) ~ L0 + A0 + L, 
#                      data = mod_data_a, cluster = ID)
#survfit_cov <- coxph(Surv(tstart, tstop, Delta == 3) ~ L0 + A0, 
#                     data = mod_data_a[at_risk_cov == 1], cluster = ID)
#survfit_death$coefficients 
#survfit_cens$coefficients 
#survfit_cov$coefficients
```

# A more meaningful estimand

Should we include censoring?

```{r}
N <- 5000
data_A <- sim_data_setting2(N = N, beta_L_D = 1, cens = 1)

# Finding all the T2D people and setting T_0 to debut time of diabetes
T2D_events <- data_A[Delta == 3]
T2D_peeps <- data_A[ID %in% T2D_events$ID]
T2D_peeps[, Time_T2D := Time - min(Time), by = ID]
T2D_peeps <- T2D_peeps[Delta != 3]
T2D_peeps[, Status := Delta == 1]


# Kaplan Meyer fit
library(prodlim)
fit <- prodlim(Hist(Time_T2D, Status) ~ L0 + A0, data = T2D_peeps)
plot(fit)
```
```{r}
diff_betas <- seq(0,1,by = 0.1)
for(beta in beta){
  data <- sim_data_setting2(N = N, diff_betas = 1, cens = 1)
  
  # Finding all the T2D people and setting T_0 to debut time of diabetes
  T2D_events <- data_A[Delta == 3]
  T2D_peeps <- data_A[ID %in% T2D_events$ID]
  T2D_peeps[, Time_T2D := Time - min(Time), by = ID]
  T2D_peeps <- T2D_peeps[Delta != 3]
  T2D_peeps[, Status := Delta == 1]
  
  # Kaplan meyer fit
  fit <- prodlim(Hist(Time_T2D, Status) ~ L0 + A0, data = T2D_peeps)
}
```


Vi vil gerne skabe et plot med de forskellige betaer langs x-aksen og estimatet langs y-aksen. Jeg skal lige finde ud af hvad vi gerne vil estimere her. 


