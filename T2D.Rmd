---
title: 'T2D'
output: html_document
date: "2024-10-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
# Functions

L0_to_age <- function(L0, min, max) L0 *(max - min) + min

```


```{r libraries, include=FALSE}
# Libraries
library(data.table)
library(survival)
#install.packages("rtmle")
#devtools::install_github("tagteam/rtmle")
library(rtmle)
library(ggplot2)
library(microbenchmark)
library(prodlim)
theme_set(theme_bw())
```

In the following we simulate healthcare data from a setting with 3 different types of events: Death, Censoring and T2D. Death and Censoring are terminal events and each individual can be diagnosed with T2D once. There is an initial covariate $L_0$ and initial treatment $A_0$ that affects the intensities of the different events. *For now the covariates is uniform on $(0,1)$, but we would like to make it uniform on $(50,60)$ and let it represent age. Furthermore we would like to add an additional binary covariate representing sex.* The intensities of the different events follow the form

$$\lambda_{x}(t) =  R^x(t) \lambda_{0}(x,t)\phi(x,t)$$
The function $R^x(t)$ is an at risk indicator. The baseline hazard is specified as
$$\lambda_{0}(x,t)=\eta_x \nu_x t^{\nu_x-1} $$
And
$$\phi(x,t) = \exp (\beta_{L_0 \to x} L_0 + \beta_{A_0 \to x} A_0 + \beta_{L \to x} L)$$
# Inverstigation of the effect of drug on death

The overall aim of the project is to investigate how to analyse if a drug which has an established beneficial effect on an intermediate event (onset of diabetes is delayed for people taking the drug) has an additional benefit on a terminal event (death). 

Intuitively it seems that we have answered this question by answering the specific questions

- What is the effect of the drug on the probability of T2D?
- What is the effect of the drug on the probability of death?
- What is the effect of the drug on the probability of death among T2D subjects?

However, assume that it is also well-known that the intermediate event is a risk factor for the terminal event. Then the effect of the drug on the terminal event could be 100% mediated through the intermediate event. The (naively asked) question is if using and having used the drug helps people when they get diabetes. The major challenge is the selection of the people in the study over time: people are randomized at the start of the study but at the onset of diabetes they are not randomized anymore:

+ people who are already dead are not there anymore but if the drug has an effect on death then the people who take the drug live longer and hence are more likely to get diabetes.
+ people are older in the treatment arm at the onset of diabetes due to the beneficial effect of the drug on preventing diabetes

## Effect of ...

We simulate from the T2D setting described above. We let the effect of T2D on Death, $\beta_{L \to D}$, vary from $0$ to $1$ by $0.1$. For each value of $\beta_{L \to D}$ we generate three data sets, where the effect of the initial treatment on the development of T2D is $0$, $-0.5$ and $-1$ respectively. For each data set we subset the people experiencing T2D. We set Time 0 to be the debut time of T2D. We estimate the survival function with the Kaplan Meyer estimator. For each fit we predict the survival probability 5 years after debut of T2D for a observation with $L_0 = 0.5$ and $A_0 = 0$ and $A_0 = 1$. That is a person on initial treatment, and a person not on initial treatment. We also estimate the absolute risk of developing T2D for people on Treatment and people not on Treatment. All estimates are saved in matrices.  

```{r}
diff_betas <- seq(0,1,by = 0.1)
N <- 10^4
B <- length(diff_betas)

ests <- matrix(nrow = B, ncol = 2*3)
probs <- matrix(nrow = B, ncol = 2*3)

for(b in 1:B){
  print(b)
  data0 <- sim_data_setting2(N = N, beta_L_D = diff_betas[b], beta_A0_L = 0)
  data0.5 <- sim_data_setting2(N = N, beta_L_D = diff_betas[b], beta_A0_L = -0.5)
  data1 <- sim_data_setting2(N = N, beta_L_D = diff_betas[b], beta_A0_L = -1)
  
  index <- 0
  for(data in list(data0,data0.5, data1)){
    # Finding all the T2D people and setting T_0 to debut time of diabetes
    T2D_events <- data[Delta == 3]
    T2D_peeps <- data[ID %in% T2D_events$ID]
    T2D_peeps[, Time_T2D := Time - min(Time), by = ID]
    T2D_peeps <- T2D_peeps[Delta != 3]
    T2D_peeps[, Status := Delta == 1]
    
    # Kaplan meyer fit
    fit <- prodlim(Hist(Time_T2D, Status) ~ L0 + A0, data = T2D_peeps)
    
    # Save estimate of survival probability
    preds <- predict(fit, times = 5, newdata = data.frame(L0 = c(0.5,0.5), A0 = c(0,1)))
    ests[b,(index + 1)] <- preds$`L0=0.5, A0=0`
    ests[b,(index + 2)] <- preds$`L0=0.5, A0=1`
    
    # Save estimate of absolute risk of developing T2D for people on Treatment and people not on Treatment
    probs[b,(index + 1)] <- nrow(T2D_events[A0 == 1 & Time < 5])/N
    probs[b,(index + 2)] <- nrow(T2D_events[A0 == 0 & Time < 5])/N
    
    index <- index + 2
  }
}
```

Risk of diabetes for different effects of the Drug. 
```{r}
data.table(probs = c(probs),
                        group = c(rep("A0 = 1, No effect", 11), rep("A0 = 0, No effect", 11),
                                  rep("A0 = 1, Small effect", 11), rep("A0 = 0, Small effect", 11),
                                  rep("A0 = 1, Large effect", 11), rep("A0 = 0, Large effect", 11)),
                        beta = rep(diff_betas,6)) |>
  ggplot()+
  geom_line(aes(x = beta, y = probs, colour = group))+
  ylab("Proportion of individuals with T2D")+
  xlab("Effect of T2D on Death")+
  labs(title = "Absolute risk of T2D")
```
Survival probability between subjects on Drug and subjects not on Drug, for different effects of the Drug. 
```{r}
data.table(ests = c(ests),
                        group = c(rep("A0 = 1, No effect", 11), rep("A0 = 0, No effect", 11),
                                  rep("A0 = 1, Small effect", 11), rep("A0 = 0, Small effect", 11),
                                  rep("A0 = 1, Large effect", 11), rep("A0 = 0, Large effect", 11)),
                        beta = rep(diff_betas,6)) |>
  ggplot()+
  geom_line(aes(x = beta, y = ests, colour = group))+
  ylab("Estimated survival probability")+
  xlab("Effect of T2D on Death")+
  labs("5 year survival probability since T2D")
```

Difference in survival probability between subjects on Drug and subjects not on Drug, for different effects of the Drug. 
```{r}
data.table(No_effect = ests[,2] - ests[,1], 
           Effect = ests[,4] - ests[,3], 
           Large_effect = ests[,6] - ests[,5],
           beta = rep(diff_betas,2)) |> 
  ggplot()+
  geom_line(aes(x = beta, y = No_effect, colour = "No effect of drug on T2D"))+
  geom_line(aes(x = beta, y = Effect, colour = "Small effect of drug on T2D"))+
  geom_line(aes(x = beta, y = Large_effect, colour = "Large effect of drug on T2D"))+
  ylab("Estimated survival probability")+
  scale_color_manual(values = c("darkolivegreen", "darkblue", "hotpink"))+
  xlab("Effect of T2D on Death")+
  labs("5 year survival probability since T2D")
```

## Helene forslag

*Generate large data*

```{r}
N <- 50000
data_A <- sim_data_setting2(N = N, beta_L_D = 1, cens = 0)
data_A[, at_risk_cov := as.numeric(L == 0)]
```

*Grouping data based on treatment*

```{r}
no_treat_group <- data_A[A0 == 0]
treat_group <- data_A[A0 == 1]
```

*Fit Weibull*

I feel like there is something going wrong here
```{r}
survfit <- survreg(Surv(Time, Delta == 3) ~ L0, 
                   data = no_treat_group[at_risk_cov == 1], 
                   cluster = ID,
                   dist='weibull')

survfit1 <- survreg(Surv(Time, Delta == 3) ~ L0, 
                   data = treat_group[at_risk_cov == 1], 
                   cluster = ID,
                   dist='weibull')
```


Estimates
```{r}
nu_est <- 1/survfit$scale; nu_est
eta_est <- 1/exp(survfit$coefficients[1]); eta_est
beta_l0_l_est <- - survfit$coefficients[2] / survfit$scale; beta_l0_l_est

1/survfit1$scale
1/exp(survfit1$coefficients[1])
- survfit1$coefficients[2] / survfit1$scale
```

*Generate large data set under the intervened intensity *
```{r}
N <- 10000
data_new <- sim_data_setting2(N = N, 
                              cens = 0,
                              eta = c(rep(0.1,3), eta_est),
                              nu = c(rep(1.1,3), nu_est),
                              beta_L0_L = beta_l0_l_est)
```

*Generate large data set without intervened intensity *
```{r}
data_new_no_int <- sim_data_setting2(N = N, cens = 0)
```

*Proportion of subjects dying before some time $\tau$*
```{r}
tau <- 5
mean(data_new[Delta == 1, Time] < tau) # with intervention
mean(data_new_no_int[Delta == 1, Time] < tau) # without intervention
```


