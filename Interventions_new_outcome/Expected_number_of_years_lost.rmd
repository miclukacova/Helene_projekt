---
title: 'Intervention based effects: Expected number of years lost'
author: "Michaela Lukacova"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Libraries
library(data.table)
library(survival)
library(simevent)
library(ggplot2)
library(microbenchmark)
theme_set(theme_bw())
```

We are in the T2D setting. 

# The estimand

We define the effect of an intervention \(\gamma\) as
\[\beta(P) = E_{P}(Y) - E_{P^\gamma}(Y)\]
Where \(Y\) is the outcome variable. We will now, as in Andersen 2013, use the outcome variable
\[Y = L_j(0, \tau) = \int_0^\tau F_j(t) dt = E(\tau - T_{(j)} \wedge \tau)\]
for \(\tau \geq 0\). \(T_{(j)}\) is the random variable representing the time of event of cause \(j\), and \(F_j(t) = P(T \leq t, D = j) = \int_0^t S(u) \alpha_j (u) du\) is the cumulative incidence. The variable \(L_j(0, \tau)\) is interpreted as the expected number of years lost before \(\tau\) due to cause \(j\). 

# The intervention

We consider the intervention where the eta parameter of the T2D process is multiplied by the factor alpha.

# Approximation of true value

To approximate the expectations \(E_{P}(Y)\) and \(E_{P^\gamma}(Y)\), we will simulate under the two probabilities \(P\) and \(P^\gamma\) and use the estimator
\[\hat{L}_j(0, \tau) = \frac{1}{n} \sum_{i=1}^n 1(D_i = j) (\tau - T_i \wedge \tau)\]
For large \(N\). 

```{r}
# Definition of estimator
estimator <- function(data, cause, tau) {
  mean((data$Delta == cause) * (tau - pmin(tau, data$Time)))
}
```

We define values
```{r}
B1 <- 10
N1 <- 10^5
N2 <- 10^5
tau <- 5
eta <- c(0.1, 0.1, 0.5)
nu <- c(1.1, 0.8, 1.1)

beta_L0_D <- 0.3
beta_L0_L <- 2
beta_L_D <- 1.5
beta_A0_D <- -0.1
beta_A0_L <- -2.5

alpha <- 0.5
```


```{r}
set.seed(927)
MC_ests_T2D_1 <- matrix(nrow = B1, ncol = 2)
MC_ests_T2D_2 <- matrix(nrow = B1, ncol = 2)

for(b in 1:B1){
  print(b)
  # Generate large data set without intervened intensity
  data <- simT2D(N = N1,
                 eta = eta,
                 nu = nu,
                 cens = 0,
                 beta_L0_D = beta_L0_D,
                 beta_L0_L = beta_L0_L,
                 beta_L_D = beta_L_D,
                 beta_A0_D = beta_A0_D,
                 beta_A0_L = beta_A0_L,
                 lower = 10^(-30),
                 upper = 200)

  
  # Generate large data set under the intervened intensity 
  data_int <- simT2D(N = N1,
                 eta = c(eta[1:2],eta[3]*alpha),
                 nu = nu,
                 cens = 0,
                 beta_L0_D = beta_L0_D,
                 beta_L0_L = beta_L0_L,
                 beta_L_D = beta_L_D,
                 beta_A0_D = beta_A0_D,
                 beta_A0_L = beta_A0_L,
                 lower = 10^(-30),
                 upper = 200)
  
  # expected number of years lost before \(\tau\)
  MC_ests_T2D_1[b,] <- c(estimator(data, cause = 1, tau = tau),       # without intervention
                       estimator(data_int, cause = 1, tau = tau))     # with intervention
  
  # expected number of years without diabetes before \(\tau\)
  MC_ests_T2D_2[b,] <- c(estimator(data, cause = 2, tau = tau),       # without intervention
                       estimator(data_int, cause = 2, tau = tau))     # with intervention
}
```

```{r}
beta_true2 <- mean(MC_ests_T2D_2[,1]-MC_ests_T2D_2[,2])
beta_true2
var(MC_ests_T2D_2[,1]-MC_ests_T2D_2[,2])

beta_true1 <- mean(MC_ests_T2D_1[,1]-MC_ests_T2D_1[,2])
beta_true1
var(MC_ests_T2D_1[,1]-MC_ests_T2D_1[,2])
```

# Intervention effect estimation

Gentagne estimationer:

```{r}
set.seed(735)
B <- 500
N1 <- 3000
N2 <- 10^5

# For results
simres_T2D_1 <- matrix(nrow = B, ncol = 2)
simres_T2D_2 <- matrix(nrow = B, ncol = 2)

# Defining intervention
int_alpha <- function(j, haz) {
  if(j == 2) haz <- haz * 0.5
  return(haz)
}

for(b in 1:B){
  print(b)
  # Generate "observed" data
  data <- simT2D(N = N1,
                 eta = eta,
                 nu = nu,
                 cens = 0,
                 beta_L0_D = beta_L0_D,
                 beta_L0_L = beta_L0_L,
                 beta_L_D = beta_L_D,
                 beta_A0_D = beta_A0_D,
                 beta_A0_L = beta_A0_L,
                 lower = 10^(-30),
                 upper = 200)
    
  # Estimate
  data <- IntFormatData(data, N_cols = 6)
  cox_death <- coxph(Surv(tstart, tstop, Delta == 1) ~ L0 + A0 + L, data = data)
  cox_t2d <- coxph(Surv(tstart, tstop, Delta == 2) ~ L0 + A0, data = data[L == 0])
  cox_fits <- list("D" = cox_death, "L" = cox_t2d)
  
  # Simulate under intervention
  data_int <- simEventCox(N2, cox_fits, L0_old = data$L0, A0_old = data$A0, intervention2 = int_alpha)
  
  # Simulate under "observed" intensities
  data0 <- simEventCox(N2, cox_fits, L0_old = data$L0, A0_old = data$A0)
  
  # expected number of years lost before \(\tau\)
  simres_T2D_1[b,] <- c(estimator(data0, cause = 1, tau = tau),       # without intervention
                       estimator(data_int, cause = 1, tau = tau))     # with intervention
  
  # expected number of years without diabetes before \(\tau\)
  simres_T2D_2[b,] <- c(estimator(data0, cause = 2, tau = tau),       # without intervention
                       estimator(data_int, cause = 2, tau = tau))     # with intervention
}
```

```{r}
mean(simres_T2D_1[,1]-simres_T2D_1[,2], na.rm = TRUE)
sd(simres_T2D_1[,1]-simres_T2D_1[,2], na.rm = TRUE)
quantile(simres_T2D_1[,1]-simres_T2D_1[,2], 0.025, na.rm = TRUE)
quantile(simres_T2D_1[,1]-simres_T2D_1[,2], 0.975, na.rm = TRUE)

pp1 <- ggplot()+
  geom_histogram(aes(x = simres_T2D_1[,1]-simres_T2D_1[,2], y = ..density..), 
                 color = "white", fill = "steelblue")+
  geom_vline(xintercept = beta_true1, color = "darkred")+
  xlab("Estimate") 

pp2 <- ggplot()+
  geom_histogram(aes(x = simres_T2D_2[,1]-simres_T2D_2[,2], y = ..density..), 
                 color = "white", fill = "steelblue")+
  geom_vline(xintercept = beta_true2, color = "darkred")+
  xlab("Estimate") 

ggsave("hist_sim_int_t2d_1.jpeg", pp1, width = 7, height = 5)
ggsave("hist_sim_int_t2d_2.jpeg", pp2, width = 7, height = 5)
```
