---
title: 'Simulation Study: General Setting'
output: html_document
date: "2024-10-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Libraries
library(data.table)
library(survival)
library(rtmle)
```

## Simulationg operation data

Using the wrapper

```{r}
data <- sim_op_data(50)
plot_event_data(data) 
```

Or using the general function

```{r}
N <- 100
eta <- c(0.1, 0.1, 0.1, 0.1)
nu <- c(1.1, 1.1, 1.1, 1.1)
# Effect on Operation
beta0 <- c(3, 0, 1, 3)
# Effect on Death
beta1 <- c(0, 0, -1, 1)
# Effect on Censoring
beta2 <- c(3, 0, 1, 1)
# Effect on time varying covariate
beta3 <- c(3, 0, -1, 0.5)

beta <- cbind(beta0, beta1, beta2, beta3)

# Checking whether the simulations work
data <- sim_event_data(N = N, beta = beta, eta = eta, nu = nu)
plot_event_data(data) 
```

## Simulationg survival data

```{r}
data <- sim_surv_data(100)
plot_event_data(data, title = "Survival Data")
```


## Simulating competing risk data

```{r}
data <- sim_comp_risk_data(100)
plot_event_data(data, title = "Competing Risk Data")
```

### Fitting models to the operation setting

```{r}
# Generating data
N <- 300
data_test <- sim_op_data(N = N, eta = eta, nu = nu)

# Creating a k variable
data_test[, k:= ave(ID, ID, FUN = seq_along) - 1]
data_k0 <- data_test[data_test$k == 0,]

data_k0[, tstart := 0]
data_k0[, tstop := Time]

data_k1 <- data_test[data_test$k == 1,]

data_k1[, tstart := data_k0[data_k0$ID %in% data_k1$ID,]$tstop]
data_k1[, tstop := Time]

data_k2 <- data_test[data_test$k == 2,]

data_k2[, tstart := data_k1[data_k1$ID %in% data_k2$ID,]$tstop]
data_k2[, tstop := Time]

final_data <- rbind(data_k0, data_k1, data_k2)[order(ID)]

#sanity check
nrow(final_data) == nrow(data_test)

survfit_oper <- coxph(Surv(tstart, tstop, Delta == 0) ~ L0 + k + A + L, data = final_data, cluster = ID)
survfit_cens <- coxph(Surv(Time, Delta == 1) ~ L0 + k + A + L, data = final_data, cluster = ID)
survfit_death <- coxph(Surv(Time, Delta == 2) ~ L0 + k + A + L, data = final_data, cluster = ID)
survfit_cov <- coxph(Surv(Time, Delta == 3) ~ L0 + k + A, data = final_data, cluster = ID)
confint(survfit_oper); beta0
confint(survfit_cens); beta1
confint(survfit_death); beta2
confint(survfit_cov); beta3

```

### Profiling

```{r}
library(profvis)

profvis({
  simple1(1000, c(1,2,3), c(0.2,0.2,0.2), c(1.2,1.2,1.2))
})

```


The time is spent on
- Finding the inverse. But I dont think we can find an analytical expression? 
- Computing the summed cumulative hazard. Might be an idea to implement a simplified version.
- Creating dataframes and binding them together. 


# Old stuff

### Simulation function

The simulation function is a function of
- Number of individuals: `N`.

- The effect of the baseline covariates and $k$ and on the different intensities: $\beta^x \in \mathbb{R}^{4}$ where $x \in X$. This input, `beta`, should be given as a matrix where each column corresponds to an event $x \in X$. The first row is the effect of the baseline covariate $L_0$, the second row is the effect of $k$, the third row is the effect of treatment $A$, and the fourth row is the effect of time varying covariate $L_1$. 

- The shape `eta` and scale `nu` parameters $(\eta^x)_{x \in X} \in \mathbb{R}^{|X|}$ and $(\nu^x)_{x \in X} \in \mathbb{R}^{|X|}$

- The at risk function `at_risk_func`: an indicator function indicating whether the individual is at risk for the event $x$ at time $t$.

- The terminal events `Delta_Term`: a vector of the terminal events.



### Notation

We use the following notation. 

$x \in \{1,...,m}$ denotes the event type. $x=0$ corresponds to the operation event, $x=1$ to the censoring event, $x=2$ to the death event, $x = 3$ corresponds to a change in the covariate process (e.g. a worsening in condition). 
