---
title: "T2D Scenarios and Estimators"
output:
  pdf_document:
    latex_engine: xelatex
  html_document: default
date: "2024-10-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r libraries, include=FALSE}
# Libraries
library(data.table)
library(survival)
#install.packages("rtmle")
#devtools::install_github("tagteam/rtmle")
library(rtmle)
library(ggplot2)
library(prodlim)
library(knitr)
theme_set(theme_bw())
source("~/Projekt Event History/compare_effects_2.R")
```


# The Aim

The overall aim of the project is to investigate how to analyse if a drug which has an established beneficial effect on an intermediate event (onset of diabetes is delayed for people taking the drug) has an additional benefit on a terminal event (death). 

Intuitively it seems that we have answered this question by answering the specific questions

- What is the effect of the drug on the probability of death?
- What is the effect of the drug on the probability of death among T2D subjects?

However, assume that it is also well-known that the intermediate event is a risk factor for the terminal event. Then the effect of the drug on the terminal event could be 100% mediated through the intermediate event. The (naively asked) question is if using and having used the drug helps people when they get diabetes. The major challenge is the selection of the people in the study over time: people are randomized at the start of the study but at the onset of diabetes they are not randomized anymore:

+ people who are already dead are not there anymore but if the drug has an effect on death then the people who take the drug live longer and hence are more likely to get diabetes.
+ people are older in the treatment arm at the onset of diabetes due to the beneficial effect of the drug on preventing diabetes.

# The set up

Simulations are carried out in a setting where patients can experience $2$ different events: Death (1) and Type-2-Diabetes (2). Death is a terminal events and each individual can be diagnosed with T2D once. There are two baseline covariate $L_0$ and $L_1$, and a baseline treatment $A_0$. The covariate $L_0$ is uniform on $(40,60)$ and represents age. The binary covariate $L_1$ represents sex. Effects of covariates $L_0$, $A_0$ and T2D on the intensities of the events can be specified by the user by the beta arguments of the simulation function. The intensities of the different events follow the form
$$\lambda_{x}(t) =  R^x(t) \lambda_{0}(x,t)\phi(x,t)$$
The function $R^x(t)$ is an at risk indicator. The baseline hazard is specified as
$$\lambda_{0}(x,t)=\eta_x \nu_x t^{\nu_x-1} $$
And
$$\phi(x,t) = \exp \left(\frac{\beta_{L_0, x}}{50} L_0  + \beta_{L_1, x} L_1 + \beta_{A_0, x} A_0 + \beta_{L, x} L\right)$$
Below we will for two different settings look at three different ways of evaluating the effect of treatment on death. We will look at

+ Proportion of dead treatment and placebo patients a year after T2D diagnose
+ Kaplan-Meier estimated survival probability a year after T2D diagnose for respectively treatment and placebo patients. 
+ An intervention based estimate

We simulate $2*10^4$ individuals per estimate, and have no censoring. 

# Setting A

Below we estimate the proportion and survival probability in three different scenarios: where the effect of the drug on Death is $0$, $-0.1$ and $-0.2$. The effect of $A_0$ on T2D is let to vary from $-2.5$ to $0$ by $0.15$. The effect of $L_0$ on T2D is large ($=2$). And the effect of T2D on death is moderate ($=1$). There is no effect of $L_0$ directly on death. 

```{r, results='hide'}
N <- 200 #2 * 10^4

estimator2 <- function(data, N) {
  # T2D events
  T2D_events <- data[Delta == 3]
  # T2D people
  T2D_peeps <- data[ID %in% T2D_events$ID]
 
  # Setting T_0 to debut time of diabetes
  T2D_peeps[, Time_T2D := Time - min(Time), by = ID]
  # Removing the new Time 0
  T2D_peeps <- T2D_peeps[Delta != 3]
  
  # Proportion of treatment and placebo patients who have died before 1 year after T2D diagnose
  prop_treat <- nrow(T2D_peeps[Time_T2D < 1 & Delta == 1 & A0 == 1]) / length(unique(T2D_peeps[A0 == 1]$ID))
  prop_plac <- nrow(T2D_peeps[Time_T2D < 1 & Delta == 1 & A0 == 0]) / length(unique(T2D_peeps[A0 == 0]$ID))
  
  # Proportion of treatment and placebo patients who have died before 1 year after T2D diagnose
  prop_treat <- nrow(T2D_peeps[Time_T2D < 1 & Delta == 1 & A0 == 1]) / length(unique(T2D_peeps[A0 == 1]$ID))
  prop_plac <- nrow(T2D_peeps[Time_T2D < 1 & Delta == 1 & A0 == 0]) / length(unique(T2D_peeps[A0 == 0]$ID))
    
  # Kaplan meyer fit
  fit <- prodlim(Hist(Time_T2D, Delta == 1) ~ A0, data = T2D_peeps)
    
  # Save estimate of survival probability
  preds <- predict(fit, times = 1, newdata = data.frame(A0 = c(0,1)))
  
  return(c(prop_plac, prop_treat, preds$`A0=0`, preds$`A0=1`))
}

res5 <- compare_effects2(estimator = estimator2, N = N, eta = c(0.1,0.3,0.1,0.1), 
                         nu = c(1.1,1.3,1.1,1.1),
                         beta_L0_L = 2, beta_A0_L = seq(-2.5, 0, by = 0.15), 
                         beta_L_D = 1, beta_L0_D = 0)
```
Below the plots show the proportion dead for different effects of the drug on death. 

```{r}
plot_compare(res5[,1:6], diff_betas = seq(-2.5, 0, by = 0.2))+
  ylab("Proportion dead")+
  xlab("Effect of A0 on T2D")+
  labs(title = "Proportion Dead 2 year after T2D")
```
We now turn to a similar plot. Three different scenarios are considered: 1) no effect of T2D on death (0), 2) moderate effect of L on death (0.5), 3) larger effect of L on death (1). And no effect of drug on death. All other parameters are the same. 

```{r, results='hide'}
N <- 1.5*10^4
res6 <- compare_effects3(estimator = estimator2, N = N, eta = c(0.1,0.3,0.1,0.1), 
                         nu = c(1.1,1.3,1.1,1.1),
                         beta_L0_L = 2, beta_A0_L = seq(-2.5, 0, by = 0.2), beta_L0_D = 0)
```
Below the plots show the proportion dead for different effects of the drug on death. 

```{r}
plot_compare3(res6, diff_betas = seq(-2.5, 0, by = 0.2))+
  ylab("Proportion dead")+
  xlab("Effect of A0 on T2D")+
  labs(title = "Proportion Dead 2 year after T2D")
```
