---
title: 'Simulation Study: General Setting'
output: html_document
date: "2024-10-18"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Libraries
library(gridExtra)
library(tidyverse)
source("~/Helene_projekt/Source code/sim_surv.R")
```

### At risk functions

At risk functions for common settings.

```{r}
at_risk_sur <- function(x, k) as.numeric(k == 0)

at_risk_comp <- function(x, k)  as.numeric(k == 0)

at_risk_op <- function(x, k) {
  # x == 1 and x == 2 correspond to censoring and death
  if(x == 1 | x == 2) as.numeric(k == 0 | k == 1)
  # x == 0 corresponds to operation
  else as.numeric(k == 0)
}
 
```

### Simulation function

We create a simulation function that is a function of
- Number of individuals: `N`.
- The effect of the baseline covariate and $k$ (the number of the event) on the different intensities: $\beta^x \in \mathbb{R}^{2}$ where $x \in X$. This input `beta` should be given as a matrix where each column corresponds to an event $x \in X$.
- The shape `eta` and scale `nu` parameters $(\eta^x)_{x \in X} \in \mathbb{R}^{|X|}$ and $(\nu^x)_{x \in X} \in \mathbb{R}^{|X|}$
- The at risk function `at_risk_func`: an indicator function indicating whether the individual is at risk for the event $x$ at time $t$.
- The terminal events `Delta_Term`: a vector of the terminal events.

Trying out the new simulation function

```{r}
N <- 100
eta <- c(0.1, 0.1, 0.1)
nu <- c(1.1, 1.1, 1.1)
beta <- matrix(c(3, 0.1, 0, 3, 0.1, -1, 3, 0.1, 0), ncol = 3)

term_deltas <- c(1, 2)

# Checking whether the simulations work
sur_sim(N = N, beta = beta, eta = eta, nu = nu, at_risk = at_risk_op, 
        term_deltas = term_deltas)
sur_sim(N = N, beta = beta[,2:3], eta = eta[2:3], nu = nu[2:3], at_risk = at_risk_sur, 
        term_deltas = c(0,1))
sur_sim(N = N, beta = beta, eta = eta, nu = nu, at_risk = at_risk_comp, 
        term_deltas = c(0,1,2))


#survsim::sur_sim(N = N, beta = beta, eta = eta, nu = nu, at_risk = at_risk_op, 
#        term_deltas = term_deltas)

```

## Testing out the simulation function

## Testing out the simulation function

We test whether the fitted model estimates beta approximately corectly.

```{r}
# Survival setting
N <- 200
data <- sur_sim(N = N, beta = beta[,2:3], eta = eta[2:3], nu = nu[2:3], at_risk = at_risk_sur, 
        term_deltas = c(0,1))

ggplot(data) +
  geom_point(aes(x = L0, y = Time))+
  facet_wrap(~A)


library(survival)
survfit <- coxph(Surv(Time, Delta == 0) ~ L0 + A, data = data)
summary(survfit)

# Competing risks setting
N <- 50
data1 <- sur_sim(N = N, beta = beta, eta = eta, nu = nu, at_risk = at_risk_op, 
        term_deltas = term_deltas)

data1[data1$ID == 9,]

plotdata <- rbind(data1, data.frame("ID" = unique(data1$ID), L0 = unique(data1$L0), "Time" = 0, "Delta" = "start"))
ggplot(plotdata) +
  geom_point(aes(x = Time, y = ID, shape = factor(Delta))) +
  theme_minimal()+
  geom_line(aes(x = Time, y = ID, group = ID))+
  labs(title = "Competing risks survival data", shape = "Event")

```













